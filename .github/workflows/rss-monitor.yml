name: RSS Monitor Automation

on:
  schedule:
    # 每小时运行一次
    - cron: '0 * * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Verify FFmpeg installation
      run: |
        ffmpeg -version
        ffprobe -version

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create .env file
      run: |
        cat > .env << EOF
        # AI 模型配置
        GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
        GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}

        # 飞书开放平台配置
        FEISHU_APP_ID=${{ secrets.FEISHU_APP_ID }}
        FEISHU_APP_SECRET=${{ secrets.FEISHU_APP_SECRET }}
        FEISHU_BITABLE_APP_TOKEN=${{ secrets.FEISHU_BITABLE_APP_TOKEN }}
        FEISHU_TABLE_ID=${{ secrets.FEISHU_TABLE_ID }}
        FEISHU_BITABLE_TABLE_ID=${{ secrets.FEISHU_TABLE_ID }}

        # RSS订阅源列表
        RSS_FEEDS=${{ secrets.RSS_FEEDS }}

        # 微信RSS源配置
        WEWE_RSS_URL=${{ secrets.WEWE_RSS_URL }}

        # 测试模式
        TEST_MODE=false
        EOF

    - name: Run RSS Monitor
      run: |
        python main.py

    - name: Upload logs as artifact (optional)
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: execution-logs
        path: |
          history.json
          wewe_history.json
          wewe_articles/
          transcripts/
          retention-days: 7